<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Formations | Responsable Formation</title>
  <style>
    /* Styles globaux améliorés */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #2d3748;
      margin: 0;
      padding: 20px;
    }

    /* En-tête modernisé - Thème gris clair avec accents bleus */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #334155;
      padding: 1rem 2rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
    }

    .app-title {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .app-title i {
      margin-right: 10px;
      font-size: 1.8rem;
      color: #2563eb; /* Bleu accent */
    }

    .header-actions {
      display: flex;
      gap: 15px;
    }

    /* Boutons avec accents bleus */
    .p-button-primary {
      background-color: #2563eb; /* Bleu vif */
      border-color: #2563eb;
    }
    .p-button-primary:hover {
      background-color: #1d4ed8;
      border-color: #1d4ed8;
    }

    .p-button-help {
      background-color: #3b82f6; /* Bleu moyen */
      border-color: #3b82f6;
    }
    .p-button-help:hover {
      background-color: #2563eb;
      border-color: #2563eb;
    }

    /* Conteneur principal avec bordure bleue subtile */
    .main-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid #e2e8f0;
      border-top: 3px solid #3b82f6; /* Ligne bleue en haut */
    }

    /* Onglets améliorés avec indicateur bleu */
    .custom-tabview .p-tabview-nav {
      border-radius: 8px 8px 0 0;
      background: #f8fafc;
      border-color: #e2e8f0;
    }

    .custom-tabview .p-tabview-nav li .p-tabview-nav-link {
      transition: all 0.3s;
    }

    .custom-tabview .p-tabview-nav li.p-highlight .p-tabview-nav-link {
      color: #2563eb;
      border-color: #2563eb;
    }

    .custom-tabview .p-tabview-panels {
      border-radius: 0 0 8px 8px;
      padding: 1.5rem;
      background: white;
      border: 1px solid #e2e8f0;
      border-top: none;
    }

    /* Tableaux modernisés avec accents bleus */
    .enhanced-table {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .search-box {
      position: relative;
      width: 300px;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #64748b;
    }

    .search-box input {
      width: 100%;
      padding: 0.5rem 1rem 0.5rem 2.5rem;
      border-radius: 20px;
      border: 1px solid #e2e8f0;
      transition: all 0.3s;
      background-color: #f8fafc;
    }

    .search-box input:focus {
      outline: none;
      border-color: #3b82f6; /* Bleu pour le focus */
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .table-info {
      font-size: 0.875rem;
      color: #64748b;
    }

    /* Lignes de tableau améliorées avec effets bleus */
    .formation-row td {
      vertical-align: top;
      padding: 1rem 0.75rem;
      border-bottom: 1px solid #f1f5f9;
    }

    .formation-title {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.25rem;
    }

    .formation-title:hover {
      color: #2563eb; /* Bleu au survol */
    }

    .formation-description {
      font-size: 0.875rem;
      color: #64748b;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .formation-type {
      font-weight: 500;
      color: #475569;
    }

    .formation-subtype {
      font-size: 0.875rem;
      color: #94a3b8;
    }

    .date-range {
      font-size: 0.875rem;
    }

    .date-label {
      font-size: 0.75rem;
      color: #94a3b8;
      display: block;
    }

    /* Badges modernes avec bleu */
    .status-badge {
      font-weight: 600;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
    }

    .participants-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #dbeafe; /* Fond bleu très clair */
      color: #2563eb; /* Texte bleu */
      border-radius: 50%;
      width: 26px;
      height: 26px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    /* Boutons d'action avec bleu */
    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      background-color: #f1f5f9;
      color: #64748b;
      border: none;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      background-color: #dbeafe; /* Bleu très clair */
      color: #2563eb; /* Icône bleue */
    }

    /* Message vide stylisé */
    .empty-message {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }

    .empty-message i {
      font-size: 3rem;
      color: #cbd5e1;
      margin-bottom: 1rem;
      display: block;
    }

    /* Dialogues modernisés avec accents bleus */
    .modern-dialog .p-dialog-header {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #334155;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      border-bottom: 1px solid #e2e8f0;
    }

    .modern-dialog .p-dialog-header i {
      color: #2563eb; /* Icône bleue */
    }

    .dialog-content {
      padding: 1.5rem;
    }

    /* Style du dialogue participants */
    .participants-dialog .p-dialog-header {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #334155;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }

    /* Styles pour les participants */
    .participant-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .participant-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #dbeafe; /* Fond bleu très clair */
      color: #2563eb; /* Texte bleu */
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }

    .participant-details {
      display: flex;
      flex-direction: column;
    }

    .participant-name {
      font-weight: 600;
      color: #1e293b;
    }

    .participant-name:hover {
      color: #2563eb; /* Bleu au survol */
    }

    .participant-meta {
      display: flex;
      gap: 8px;
      font-size: 0.75rem;
      color: #64748b;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Style des badges */
    .matricule-badge {
      background: #dbeafe; /* Fond bleu très clair */
      padding: 4px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9rem;
      color: #2563eb; /* Texte bleu */
    }

    /* Style des liens email */
    .email-link {
      color: #64748b;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .email-link:hover {
      color: #2563eb; /* Bleu au survol */
      text-decoration: underline;
    }

    .email-link i {
      color: #3b82f6; /* Icône bleue */
    }

    /* Style des documents */
    .document-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .document-status {
      font-size: 0.875rem;
    }

    .document-status.success {
      color: #10b981;
    }

    .document-status.error {
      color: #ef4444;
    }

    /* Style de l'évaluation */
    .evaluation-form {
      padding: 8px 0;
    }

    .radio-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .radio-option {
      display: flex;
      align-items: center;
    }

    .evaluation-result {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .result-tag {
      font-weight: 600;
      padding: 0.35rem 0.75rem;
    }

    .edit-btn {
      color: #64748b;
    }

    .edit-btn:hover {
      color: #2563eb; /* Bleu au survol */
    }

    /* État vide */
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #64748b;
    }

    .empty-state i {
      margin-bottom: 1rem;
      color: #cbd5e1;
      font-size: 2rem;
    }

    .empty-state p {
      margin-top: 0.5rem;
    }

    /* Calendrier */
    .fc-event {
      background-color: #3b82f6 !important; /* Bleu pour les événements */
      border-color: #3b82f6 !important;
    }

    .fc-event:hover {
      background-color: #2563eb !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .search-box {
        width: 100%;
      }
    }

    @media (max-width: 992px) {
      .participants-dialog .p-dialog {
        width: 90vw !important;
      }
    }

    /* Bouton calendrier */
    .calendar-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
    }

    /* Style pour le bouton d'impression */
    .printBtn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      margin-right: 10px;
    }

    .printBtn svg {
      fill: #3b82f6;
    }

    .printBtn:hover svg {
      fill: #2563eb;
    }

    /* Confirmation dialog */
    .confirmation-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }
  </style>
</head>
<body>

<!-- En-tête modernisé -->
<div class="app-header">
  <div class="app-title">
    <i class="pi pi-book"></i>
    <span>Gestion des Formations - Responsable</span>
  </div>
  <div class="header-actions">
    <button pButton type="button" icon="pi pi-calendar" 
            (click)="openCalendarDialog()" 
            class="p-button-rounded p-button-help"
            pTooltip="Vue calendrier" tooltipPosition="bottom"></button>
  </div>
</div>

<!-- Conteneur principal -->
<div class="main-container">
  <p-card header="Liste des Formations" [style]="{ 'border-radius': '10px' }" class="p-shadow-3">
    <p-tabView class="custom-tabview">
      
      <!-- Dialogue Détails de la formation -->
      <p-dialog
        header="Détails de la formation"
        [(visible)]="displayEventDialog"
        [modal]="true"
        [style]="{ width: '450px' }"
        [draggable]="false"
        [resizable]="false"
        class="modern-dialog"
      >
        <div class="dialog-content" *ngIf="selectedEvent">
          <p><strong>Titre :</strong> {{ selectedEvent.title }}</p>
          <p><strong>Description :</strong> {{ selectedEvent.description }}</p>
          <p><strong>Type de formation :</strong> {{ selectedEvent.typeFormation }}</p>
          <p><strong>Sous-type de formation :</strong> {{ selectedEvent.sousTypeFormation }}</p>
          <p><strong>Début :</strong> {{ selectedEvent.start | date: 'dd/MM/yyyy' }}</p>
          <p><strong>Fin :</strong> {{ selectedEvent.end | date: 'dd/MM/yyyy' }}</p>
          <p><strong>Responsable :</strong> {{ selectedEvent.responsableEvaluation?.nom || selectedEvent.responsableEvaluationExterne || 'N/A' }}</p>
          <p><strong>Période :</strong> {{ selectedEvent.valide ? 'Validée' : 'En attente' }}</p>
        </div>
        <ng-template pTemplate="footer">
          <button
            pButton
            type="button"
            label="Fermer"
            (click)="displayEventDialog = false"
            class="p-button-text"
          ></button>
        </ng-template>
      </p-dialog>

      <!-- Onglet Formations en Attente -->
      <p-tabPanel header="En Attente" leftIcon="pi pi-clock">
        <div class="enhanced-table">
          <p-table
            #dt1
            [value]="formationsNonValidees"
            [globalFilterFields]="['titre', 'description', 'typeFormation', 'sousTypeFormation', 'responsableEvaluationExterne']"
            selectionMode="single"
            [(selection)]="selectedFormation"
            dataKey="id"
            [rows]="10"
            [paginator]="true"
            stateStorage="session"
            stateKey="statedemo-session"
            styleClass="p-datatable-striped p-datatable-gridlines"
          >
            <ng-template pTemplate="caption">
              <div class="table-header">
                <div class="search-box">
                  <i class="pi pi-search"></i>
                  <input
                    pInputText
                    type="text"
                    (input)="dt1.filterGlobal($any($event.target).value, 'contains')"
                    placeholder="Rechercher une formation..."
                  />
                </div>
                <div class="table-info">
                  {{formationsNonValidees.length || 0}} formations en attente
                </div>
              </div>
            </ng-template>
            
            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="titre" style="width:22%">Titre <p-sortIcon field="titre" /></th>
                <th pSortableColumn="typeFormation" style="width:15%">Type <p-sortIcon field="typeFormation" /></th>
                <th style="width:15%">Dates</th>
                <th pSortableColumn="responsableEvaluation" style="width:15%">Responsable <p-sortIcon field="responsableEvaluation" /></th>
                <th style="width:10%">Participants</th>
                <th style="width:10%">Période</th>
                <th style="width:8%">Validation</th>
                <th style="width:15%">Date de Rappel</th>

              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-formation>
              <tr class="formation-row">
                <td>
                  <div class="formation-title">{{ formation.titre }}</div>
                  <div class="formation-description">{{ formation.description }}</div>
                </td>
                <td>
                  <div class="formation-type">{{ formation.typeFormation }}</div>
                  <div class="formation-subtype">{{ formation.sousTypeFormation }}</div>
                </td>
                <td>
                  <div class="date-range">
                    <span class="date-label">Début:</span> 
                    {{ formation.dateDebutPrevue | date: 'dd/MM/yyyy' }}
                  </div>
                  <div class="date-range">
                    <span class="date-label">Fin:</span> 
                    {{ formation.dateFinPrevue | date: 'dd/MM/yyyy' }}
                  </div>
                </td>
                <td>{{ formation.responsableEvaluation?.nom || formation.responsableEvaluationExterne || 'N/A' }}</td>
                <td class="text-center">
                  <button pButton icon="pi pi-users" 
                          (click)="showParticipants(formation)"
                          class="p-button-rounded p-button-text p-button-plain action-btn"
                          pTooltip="Voir participants" tooltipPosition="top"></button>
                  <span class="participants-badge">{{formation.employes?.length || 0}}</span>
                </td>
                <td>
                  <p-tag [severity]="getStatusSeverity(formation.dateFinPrevue)" 
                         [value]="getFormationStatus(formation.dateFinPrevue)"
                         styleClass="status-badge"></p-tag>
                </td>
                <td>
                  <p-tag severity="warn" icon="pi pi-clock" value="En attente" styleClass="status-badge"></p-tag>
                </td>
                <td>
                  <!-- Tag pour la date de rappel définie -->
                  <p-tag *ngIf="formation.dateRappel" 
                         severity="success" 
                         [value]="'Rappel: ' + (formation.dateRappel | date: 'dd/MM/yyyy')"
                         styleClass="date-tag">
                  </p-tag>
                  
                  <!-- Tag pour la date par défaut (si pas de date définie) -->
                  <p-tag *ngIf="!formation.dateRappel && formation.dateFinPrevue" 
                         severity="info" 
                         [value]="'Défaut: ' + (getDefaultRappelDate(formation.dateFinPrevue) | date: 'dd/MM/yyyy')"
                         styleClass="date-tag">
                  </p-tag>
              
                  <!-- Bouton Modifier (visible quand un tag est affiché) -->
                  <button *ngIf="formation.dateRappel || (!formation.dateRappel && formation.dateFinPrevue)"
                          pButton 
                          icon="pi pi-pencil" 
                          class="p-button-rounded p-button-text p-button-sm" 
                          (click)="toggleCalendar(formation.id)" 
                          pTooltip="Modifier la date de rappel" 
                          tooltipPosition="top">
                  </button>
              
                  <!-- Bouton Ajouter (visible quand aucun tag n'est affiché) -->
                  <button *ngIf="!formation.dateRappel && !formation.dateFinPrevue"
                          pButton 
                          icon="pi pi-calendar-plus" 
                          class="p-button-rounded p-button-text p-button-sm" 
                          (click)="toggleCalendar(formation.id)" 
                          pTooltip="Ajouter une date de rappel" 
                          tooltipPosition="top">
                  </button>
              
                  <input *ngIf="isCalendarVisible(formation.id)"
                         type="date"
                         [(ngModel)]="formation.dateRappel"
                         [min]="formation.dateDebutPrevue | date: 'yyyy-MM-dd'"
                         [max]="formation.dateFinPrevue | date: 'yyyy-MM-dd'"
                         (change)="onDateSelect(formation)"
                         (blur)="onDateSelect(formation)"
                         class="form-control">
              </td>
                
                
              </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="7">
                  <div class="empty-message">
                    <i class="pi pi-inbox"></i>
                    <p>Aucune formation en attente trouvée</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </p-tabPanel>

      <!-- Onglet Formations Validées -->
      <p-tabPanel header="Validées" leftIcon="pi pi-check-circle">
        <div class="enhanced-table">
          <p-table
            #dt2
            [value]="formationsValidees"
            [globalFilterFields]="['titre', 'description', 'typeFormation', 'sousTypeFormation', 'responsableEvaluationExterne']"
            selectionMode="single"
            [(selection)]="selectedFormation"
            dataKey="id"
            [rows]="10"
            [paginator]="true"
            stateStorage="session"
            stateKey="statedemo-session"
            styleClass="p-datatable-striped p-datatable-gridlines"
          >
            <ng-template pTemplate="caption">
              <div class="table-header">
                <div class="search-box">
                  <i class="pi pi-search"></i>
                  <input
                    pInputText
                    type="text"
                    (input)="dt2.filterGlobal($any($event.target).value, 'contains')"
                    placeholder="Rechercher une formation..."
                  />
                </div>
                <div class="table-info">
                  {{formationsValidees.length || 0}} formations validées
                </div>
              </div>
            </ng-template>
            
            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="titre" style="width:22%">Titre <p-sortIcon field="titre" /></th>
                <th pSortableColumn="typeFormation" style="width:15%">Type <p-sortIcon field="typeFormation" /></th>
                <th style="width:15%">Dates</th>
                <th pSortableColumn="responsableEvaluation" style="width:15%">Responsable <p-sortIcon field="responsableEvaluation" /></th>
                <th style="width:10%">Participants</th>
                <th style="width:10%">Période</th>
                <th style="width:8%">Validation</th>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-formation>
              <tr class="formation-row">
                <td>
                  <div class="formation-title">{{ formation.titre }}</div>
                  <div class="formation-description">{{ formation.description }}</div>
                </td>
                <td>
                  <div class="formation-type">{{ formation.typeFormation }}</div>
                  <div class="formation-subtype">{{ formation.sousTypeFormation }}</div>
                </td>
                <td>
                  <div class="date-range">
                    <span class="date-label">Début:</span> 
                    {{ formation.dateDebutPrevue | date: 'dd/MM/yyyy' }}
                  </div>
                  <div class="date-range">
                    <span class="date-label">Fin:</span> 
                    {{ formation.dateFinPrevue | date: 'dd/MM/yyyy' }}
                  </div>
                </td>
                <td>{{ formation.responsableEvaluation?.nom || formation.responsableEvaluationExterne || 'N/A' }}</td>
                <td class="text-center">
                  <button pButton icon="pi pi-users" 
                          (click)="showParticipants(formation)"
                          class="p-button-rounded p-button-text p-button-plain action-btn"
                          pTooltip="Voir participants" tooltipPosition="top"></button>
                  <span class="participants-badge">{{formation.employes?.length || 0}}</span>
                </td>
                <td>
                  <p-tag [severity]="getStatusSeverity(formation.dateFinPrevue)" 
                         [value]="getFormationStatus(formation.dateFinPrevue)"
                         styleClass="status-badge"></p-tag>
                </td>
                <td>
                  <p-tag severity="success" icon="pi pi-check" value="Validée" styleClass="status-badge"></p-tag>
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="7">
                  <div class="empty-message">
                    <i class="pi pi-inbox"></i>
                    <p>Aucune formation validée trouvée</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </p-tabPanel>
      <!-- Onglet Formations à Corriger -->
<p-tabPanel header="À Corriger" leftIcon="pi pi-exclamation-triangle">
  <div class="enhanced-table">
    <p-table
      #dt3
      [value]="formationsNoncorrige"
      [globalFilterFields]="['titre', 'description', 'typeFormation', 'sousTypeFormation', 'responsableEvaluationExterne']"
      selectionMode="single"
      [(selection)]="selectedFormation"
      dataKey="id"
      [rows]="10"
      [paginator]="true"
      stateStorage="session"
      stateKey="statedemo-session"
      styleClass="p-datatable-striped p-datatable-gridlines"
    >
      <ng-template pTemplate="caption">
        <div class="table-header">
          <div class="search-box">
            <i class="pi pi-search"></i>
            <input
              pInputText
              type="text"
              (input)="dt3.filterGlobal($any($event.target).value, 'contains')"
              placeholder="Rechercher une formation..."
            />
          </div>
          <div class="table-info">
            {{formationsNoncorrige.length || 0}} formations à corriger
          </div>
        </div>
      </ng-template>
      
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="titre" style="width:20%">Titre <p-sortIcon field="titre" /></th>
          <th pSortableColumn="typeFormation" style="width:15%">Type <p-sortIcon field="typeFormation" /></th>
          <th style="width:15%">Dates</th>
          <th pSortableColumn="responsableEvaluation" style="width:15%">Responsable <p-sortIcon field="responsableEvaluation" /></th>
          <th style="width:10%">Participants</th>
          <th style="width:10%">Période</th>
          <th style="width:15%">Commentaire</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-formation>
        <tr class="formation-row">
          <td>
            <div class="formation-title">{{ formation.titre }}</div>
            <div class="formation-description">{{ formation.description }}</div>
          </td>
          <td>
            <div class="formation-type">{{ formation.typeFormation }}</div>
            <div class="formation-subtype">{{ formation.sousTypeFormation }}</div>
          </td>
          <td>
            <div class="date-range">
              <span class="date-label">Début:</span> 
              {{ formation.dateDebutPrevue | date: 'dd/MM/yyyy' }}
            </div>
            <div class="date-range">
              <span class="date-label">Fin:</span> 
              {{ formation.dateFinPrevue | date: 'dd/MM/yyyy' }}
            </div>
          </td>
          <td>{{ formation.responsableEvaluation?.nom || formation.responsableEvaluationExterne || 'N/A' }}</td>
          <td class="text-center">
            <button pButton icon="pi pi-users" 
                    (click)="showParticipants(formation)"
                    class="p-button-rounded p-button-text p-button-plain action-btn"
                    pTooltip="Voir participants" tooltipPosition="top"></button>
            <span class="participants-badge">{{formation.employes?.length || 0}}</span>
          </td>
          <td>
            <p-tag [severity]="getStatusSeverity(formation.dateFinPrevue)" 
                   [value]="getFormationStatus(formation.dateFinPrevue)"
                   styleClass="status-badge"></p-tag>
          </td>
          <td>
            <div class="comment-display-container">
              <div *ngIf="formation.commentaire; else noComment" class="commentaire-cell">
                <div [innerHTML]="getFormattedComment(formation.commentaire)"></div>
              </div>
              <ng-template #noComment>
                <div class="empty-comment">
                  <i class="pi pi-info-circle"></i> Aucun commentaire
                </div>
              </ng-template>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7">
            <div class="empty-message">
              <i class="pi pi-inbox"></i>
              <p>Aucune formation à corriger trouvée</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-tabPanel>
    </p-tabView>
  </p-card>
</div>

<!-- Dialogue Calendrier modernisé -->
<p-dialog header="Calendrier des Formations" [(visible)]="displayCalendarDialog" [modal]="true" 
          [style]="{ width: '85vw', height: '85vh' }" [draggable]="false" [resizable]="false"
          class="modern-dialog">
  <div class="dialog-content">
    <full-calendar [options]="calendarOptions"></full-calendar>
  </div>
  <ng-template pTemplate="footer">
    <button pButton label="Fermer" (click)="displayCalendarDialog = false" 
            class="p-button-text"></button>
  </ng-template>
</p-dialog>

<!-- Dialogue Participants modernisé -->
<p-dialog header="Liste des Participants" [(visible)]="displayDialog" [modal]="true" [closable]="true" 
          [style]="{ width: '70vw' }" class="participants-dialog">
  <div class="dialog-content">
    <p-table *ngIf="selectedFormation?.employes" [value]="selectedFormation.employes" [rows]="5" [paginator]="true"
             styleClass="p-datatable-gridlines p-datatable-striped">
      <ng-template pTemplate="header">
        <tr>
          <th style="min-width: 180px;">Participant</th>
          <th style="width: 120px;">Matricule</th>
          <th>Email</th>
          <th style="width: 250px;">Actions</th> <!-- Colonne élargie pour les boutons -->
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-employe>
        <tr>
          <!-- Colonne Participant -->
          <td>
            <div class="participant-info">
              <div class="participant-avatar">
                {{ employe.prenom?.charAt(0) }}{{ employe.nom?.charAt(0) }}
              </div>
              <div class="participant-details">
                <div class="participant-name">{{ employe.prenom }} {{ employe.nom }}</div>
              </div>
            </div>
          </td>
          
          <!-- Colonne Matricule -->
          <td>
            <span class="matricule-badge">{{ employe.matricule }}</span>
          </td>
          
          <!-- Colonne Email -->
          <td>
            <a href="mailto:{{ employe.email }}" class="email-link">
              <i class="pi pi-envelope"></i> {{ employe.email }}
            </a>
          </td>
          
          <!-- Colonne Actions -->
          <td>
            <div class="employee-actions">
              <!-- Bouton Voir PDF -->
              <!-- Bouton Voir PDF -->
              <button *ngIf="pdfUrls[employe.id]" pButton icon="pi pi-eye" 
              (click)="openPdfDialog(pdfUrls[employe.id], employe)"
              class="p-button-rounded p-button-outlined p-button-info action-button"
              pTooltip="Voir le document" tooltipPosition="top"></button>
  <button pButton 
            icon="pi pi-file-pdf" 
            (click)="navigateToPdfReport(employe)"
            class="p-button-rounded p-button-outlined p-button-info action-button"
            pTooltip="Générer un document PDF complet" 
            tooltipPosition="top"></button>
      <!-- Bouton Choisir PDF (visible seulement pour les formations en attente) -->


    





      <button *ngIf="selectedFormation && isFormationEnAttente(selectedFormation.id)" 
              pButton icon="pi pi-upload" 
              (click)="fileInput.click()"
              class="p-button-rounded p-button-outlined p-button-secondary action-button"
              pTooltip="Changer le document PDF" tooltipPosition="top"></button>
      
      <!-- Bouton Enregistrer (visible seulement quand un nouveau fichier est sélectionné) -->
      <div *ngIf="selectedFormation && isFormationEnAttente(selectedFormation.id) && tempPdfFiles[employe.id]"
      class="pdf-status pdf-status-success"
      pTooltip="Modifications enregistrées" tooltipPosition="top">
   <i class="pi pi-check"></i>
 </div>





              <input #fileInput type="file" (change)="onEmployeeFileSelected($event, employe)" 
                     accept="application/pdf" style="display: none;" />
            </div>
            
         
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="4">
            <div class="empty-state">
              <i class="pi pi-users" style="font-size: 2rem; color: #64748b;"></i>
              <p>Aucun participant trouvé pour cette formation</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>



  <ng-template pTemplate="footer">
    <button  *ngIf="!selectedFormation.valide"   pButton type="button" 
            label="Valider la formation" 
            icon="pi pi-check-circle" 
            (click)="displayValidationConfirmDialog = true"
            class="p-button-success" 
            [disabled]="!areAllEmployeesEvaluated()">
    </button>
  </ng-template>
  
</p-dialog>



<p-dialog header="Gestion des documents" [(visible)]="pdfDialogVisible" [modal]="true" 
         [style]="{ width: '85vw', height: '90vh' }" [draggable]="false" [resizable]="false"
         class="modern-pdf-dialog">
  
  <!-- En-tête amélioré avec indicateur de statut -->
  <div class="dialog-header">
    <div class="header-content">
      <i class="pi pi-file-pdf header-icon"></i>
      <div class="header-text">
        <h3>{{selectedFormation?.titre || 'Document PDF'}}</h3>
        <p class="document-info">
          <span *ngIf="selectedEmploye">{{selectedEmploye.nom}} {{selectedEmploye.prenom}} ({{selectedEmploye.matricule}})</span>
        </p>
      </div>
    </div>
    <p-progressBar *ngIf="pdfLoading" mode="indeterminate" style="height: 4px"></p-progressBar>
  </div>

  <!-- Conteneur principal amélioré -->
  <div class="pdf-container-wrapper" style="height: calc(100% - 120px); position: relative;">
    <!-- Overlay de chargement moderne -->
    <div *ngIf="pdfLoading" class="modern-loading-overlay">
      <div class="loading-content">
        <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
        <div class="loading-text">
          <h4>Chargement du document</h4>
          <p>Veuillez patienter pendant le traitement...</p>
        </div>
      </div>
    </div>

    <!-- Viewer PDF avec dimensions fixes -->
    <div class="pdf-viewer-container" [class.loading]="pdfLoading" style="width: 100%; height: 100%;">
      <pdf-viewer *ngIf="selectedPdfUrl && !pdfLoading"
                  [src]="selectedPdfUrl"
                  [render-text]="true"
                  [original-size]="false"
                  style="display: block; width: 100%; height: 100%; min-height: 500px;"
                  (after-load-complete)="handlePdfLoaded($event)"
                  (error)="handlePdfError($event)"
                  [key]="pdfViewerKey">
      </pdf-viewer>
      
      <!-- Indicateur de compatibilité flottant -->
      <div class="compatibility-badge" *ngIf="isDocumentCompatible !== undefined">
        <p-tag [severity]="isDocumentCompatible ? 'success' : 'danger'" 
               [icon]="isDocumentCompatible ? 'pi pi-check' : 'pi pi-exclamation-triangle'"
               [value]="isDocumentCompatible ? 'Compatible' : 'Incompatible'">
        </p-tag>
      </div>
    </div>
  </div>

  <!-- Barre d'actions modernisée -->
  <div class="modern-action-bar" style="position: absolute; bottom: 0; width: 100%; padding: 1rem; background: #f8f9fa; border-top: 1px solid #dee2e6;">
    <!-- Groupe de gauche - Actions document -->
    <div class="action-group left-actions">
       <button *ngIf="selectedFormation && isFormationEnAttente(selectedFormation.id)" 
            pButton type="button" 
            icon="pi pi-file-import" 
            label="Choisir un autre PDF" 
            (click)="fileInput.click()"
            class="p-button-outlined p-button-secondary"
           >
    </button>
      
      <input #fileInput type="file" (change)="onFileSelected($event)" accept="application/pdf" style="display:none" />
    </div>
    
    <!-- Groupe central - Vérification -->
    <div class="action-group center-actions">
      <button pButton pRipple type="button" 
              icon="pi pi-verified" 
              label="Vérifier la compatibilité" 
              (click)="verifierCompatibilite()"
              [disabled]="pdfLoading || !selectedPdfUrl"
              class="p-button-outlined verify-btn">
      </button>
    </div>
    
    <!-- Groupe de droite - Validation -->
    <div class="action-group right-actions">
      <button *ngIf="isDocumentCompatible && selectedFormation && isFormationEnAttente(selectedFormation.id)" 
              pButton pRipple type="button" 
              icon="pi pi-save" 
              label="Confirmer le document" 
              (click)="saveModifiedPdf(selectedFormation.id, selectedEmploye.id)"
              [disabled]="pdfLoading || !selectedPdfUrl"
              class="confirm-btn">
        <span class="button-badge" *ngIf="isDocumentCompatible !== undefined">✓</span>
      </button>
    </div>
  </div>
</p-dialog>

<p-dialog header="Réglage des espacements entre périodes" [(visible)]="spacingDialogVisible" [modal]="true" 
         [style]="{ width: '500px' }" class="spacing-settings-dialog">
  <div class="spacing-controls">
    <div *ngFor="let spacing of periodSpacings; let i = index" class="spacing-control">
      <label>Espacement après période {{i + 1}}:</label>
      <input type="number" [(ngModel)]="spacing.value" min="0" max="200" step="5"
             class="spacing-input" (keydown)="validateNumberInput($event)">
      <span class="px-suffix">px</span>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <button pButton type="button" label="Appliquer" icon="pi pi-check" 
            (click)="applySpacingSettings()" class="p-button-success"></button>
    <button pButton type="button" label="Annuler" icon="pi pi-times" 
            (click)="spacingDialogVisible = false" class="p-button-secondary"></button>
  </ng-template>
</p-dialog>


<!-- Dialogue de confirmation de validation -->
<p-dialog header="Confirmation de validation" [(visible)]="displayValidationConfirmDialog " 
          [modal]="true" [style]="{ width: '450px' }" class="confirmation-dialog">
  <div class="confirmation-content">
    <i class="pi pi-exclamation-triangle confirmation-icon"></i>
    <span>Vous avez évalué tous les employés. Voulez-vous valider cette formation ?</span>
  </div>
  <ng-template pTemplate="footer">
    <button pButton type="button" 
            label="Non" 
            icon="pi pi-times" 
            (click)="onRejectValidation()" 
            class="p-button-text reject-btn"></button>
    <button pButton type="button" 
            label="Oui" 
            icon="pi pi-check" 
            (click)="onConfirmValidation()" 
            class="p-button-success confirm-btn"></button>
  </ng-template>
</p-dialog>

<p-toast position="top-right"></p-toast>
<p-confirmDialog header="Confirmation" icon="pi pi-exclamation-triangle"
  [style]="{ width: '450px' }" acceptLabel="Oui" rejectLabel="Non"></p-confirmDialog>

</body>
</html>